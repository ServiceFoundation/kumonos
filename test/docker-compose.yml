version: '3'
services:
  user-app:
    build: 'app'
    environment:
      RESPONSE: 'user'
      SLEEP: 0
      ERROR_RATE: 5
    expose:
      - '8080'
  ab-testing-app:
    build: 'app'
    environment:
      RESPONSE: 'ab-testing'
      SLEEP: 0
      ERROR_RATE: 5
    expose:
      - '8080'
  nginx:
    image: 'nginx'
    volumes:
      - './nginx.conf:/etc/nginx/nginx.conf'
      - './srv:/srv'
    ports:
      - '3080:80'
  prometheus:
    image: 'prom/prometheus'
    ports:
      - '9090:9090'
    depends_on:
      - 'statsd-exporter'
    volumes:
      - './prometheus.yml:/etc/prometheus/prometheus.yml'
  statsd-exporter:
    image: 'prom/statsd-exporter'
    ports:
      - '9102:9102'
  relay:
    build: '..'
    depends_on:
      - 'statsd-exporter'
    environment:
      APP_ID: 'test'
    command:
      - "bundle"
      - "exec"
      - "./exe/kumonos-relay"
      - "--service-cluster=test"
      - "--service-node=test"
      - "0.0.0.0:2000"
      - "statsd-exporter:9125"
  envoy:
    image: 'envoyproxy/envoy:3213ef0ddef11f3dfee0883333050844a297cc5d'
    depends_on:
      - 'user-app'
      - 'ab-testing-app'
      - 'nginx'
      - 'relay'
    command:
      - 'envoy'
      - '-c'
      - '/config.json'
      - '--service-cluster'
      - 'book'
      - '--service-node'
      - 'book'
    volumes:
      - './config.json:/config.json'
    expose:
      - '9211' # service port
      - '9901' # admin port
    ports:
      - '9211:9211'
      - '9901:9901'
