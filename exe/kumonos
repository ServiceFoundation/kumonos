#!/usr/bin/env ruby
# frozen_string_literal: true

$LOAD_PATH.unshift(File.expand_path('../lib', __dir__))
require 'kumonos'

require 'pathname'
require 'thor'

# KumonosCli
class KumonosCli < Thor
  def self.exit_on_failure?
    true
  end

  desc 'envoy', 'Generate envoy configuration'
  method_option :config, aliases: '-c', desc: 'Configuration file for kumonos', required: true, type: :string
  def envoy
    path = options.fetch(:config)
    validate_path!(path)
    h = JSON.parse(File.read(path))
    validate_kumonos_config!(h, path)

    config = Kumonos::Configuration.from_hash(h)
    puts JSON.dump(Kumonos.generate(config))
  end

  desc 'clusters SERVIVE_DEFINITION_PATH', 'Generate clusters configuration'
  method_option :output, aliases: '-o', desc: 'Output directory', required: true, type: :string
  def clusters(filepath)
    validate_path!(filepath)
    validate_path!(options.fetch(:output))

    definition = YAML.load_file(filepath)
    name = File.basename(filepath, '.*')
    validate_service_definition!(definition, filepath)
    out = JSON.dump(Kumonos::Clusters.generate(definition))

    output_dir = Pathname.new(options.fetch(:output))
    target = output_dir.join('v1', 'clusters', name, name)
    target.parent.mkpath unless target.parent.exist?
    target.write(out)
    puts target
  end

  desc 'routes SERVIVE_DEFINITION_PATH', 'Generate routes configuration'
  method_option :output, aliases: '-o', desc: 'Output directory', required: true, type: :string
  def routes(filepath)
    validate_path!(filepath)
    validate_path!(options.fetch(:output))

    definition = YAML.load_file(filepath)
    name = File.basename(filepath, '.*')
    validate_service_definition!(definition, filepath)
    out = JSON.dump(Kumonos::Routes.generate(definition))

    output_dir = Pathname.new(options.fetch(:output))
    target = output_dir.join('v1', 'routes', Kumonos::DEFAULT_ROUTE_NAME, name, name)
    target.parent.mkpath unless target.parent.exist?
    target.write(out)
    puts target
  end

  desc 'init NAME', 'Generate a service definition'
  def init(name)
    definition = YAML.load_file(File.expand_path('../example/book.yml', __dir__))
    definition['dependencies'] = definition.fetch('dependencies')[0..0]
    dep = definition['dependencies'][0]
    dep['name'] = 'target-service-name'
    dep['lb'] = 'hostname-for-load-balancer:port'
    path = "#{name}.yml"
    File.open(path, 'w') { |f| YAML.dump(definition, f) }
    puts path
  end

  private

  def validate_path!(path)
    return if File.exist?(path)

    warn("No such file or directory: #{path}")
    exit 1
  end

  def validate_kumonos_config!(h, path)
    result = Kumonos::Schemas.validate_kumonos_config(h)
    return if result.empty?
    warn_and_exit(result, path, Kumonos::Schemas::CONFIG_SCHEMA_PATH)
  end

  def validate_service_definition!(h, path)
    result = Kumonos::Schemas.validate_service_definition(h)
    return if result.empty?
    warn_and_exit(result, path, Kumonos::Schemas::SERVIVE_DEFINITION_PATH)
  end

  def warn_and_exit(result, path, schema_path)
    warn("#{path} has invalid format:")
    warn(result)
    warn("The schema file is #{schema_path}")
    exit 1
  end
end

KumonosCli.start(ARGV)
